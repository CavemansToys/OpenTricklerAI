name: Build Firmware (Pico 2W - RP2350)

on:
  push:
    branches: [ main, master, rp2350-enhanced ]
  pull_request:
    branches: [ main, master, rp2350-enhanced ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Clone all dependencies
      run: |
        echo "Cloning project dependencies..."
        git clone --depth 1 https://github.com/raspberrypi/FreeRTOS-Kernel.git library/FreeRTOS-Kernel
        git clone --depth 1 https://github.com/olikraus/u8g2.git library/u8g2
        git clone --depth 1 https://github.com/terjeio/Trinamic-library.git library/Trinamic-library

    - name: Install ARM toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake gcc-arm-none-eabi libnewlib-arm-none-eabi build-essential

    - name: Setup Pico SDK with RP2350 support
      run: |
        echo "Cloning Pico SDK 2.2.0 (RP2350 Pico 2W WiFi fixes)..."
        rm -rf library/pico-sdk
        git clone --depth 1 --branch 2.2.0 https://github.com/raspberrypi/pico-sdk.git library/pico-sdk
        cd library/pico-sdk
        echo "Initializing essential SDK submodules..."
        git submodule update --init --depth 1 lib/btstack
        git submodule update --init --depth 1 lib/cyw43-driver
        git submodule update --init --depth 1 lib/lwip
        git submodule update --init --depth 1 lib/mbedtls
        echo "SDK ready"

    - name: Build BLINK-ONLY test (standalone clean example)
      run: |
        cd blink-test
        mkdir build
        cd build
        cmake .. -DPICO_SDK_PATH=$PWD/../../library/pico-sdk -DPICO_BOARD=pico2_w -DPICO_PLATFORM=rp2350
        make -j$(nproc)

    - name: Build MINIMAL test mode (no OTA, no partitions)
      run: |
        mkdir build-minimal
        cd build-minimal
        # Temporarily move partition table so it's not embedded
        mv ../partition_table.json ../partition_table.json.bak || true
        cmake .. -DPICO_PLATFORM=rp2350 -DPICO_BOARD=pico2_w -DBUILD_OTA_BOOTLOADER=OFF -DUSE_OTA_LINKER_SCRIPT=OFF -DWIFI_TEST_MODE=ON
        make -j$(nproc)
        # Restore partition table
        mv ../partition_table.json.bak ../partition_table.json || true

    - name: Build TEST mode (web-only, no hardware)
      run: |
        mkdir build-test
        cd build-test
        cmake .. -DPICO_PLATFORM=rp2350 -DPICO_BOARD=pico2_w -DBUILD_OTA_BOOTLOADER=OFF -DUSE_OTA_LINKER_SCRIPT=OFF -DWIFI_TEST_MODE=ON
        make -j$(nproc)

    - name: Build PRODUCTION mode (full hardware support)
      run: |
        mkdir build-production
        cd build-production
        cmake .. -DPICO_PLATFORM=rp2350 -DPICO_BOARD=pico2_w -DBUILD_OTA_BOOTLOADER=OFF -DUSE_OTA_LINKER_SCRIPT=OFF -DWIFI_TEST_MODE=OFF
        make -j$(nproc)

    - name: Upload BLINK-ONLY test firmware
      uses: actions/upload-artifact@v4
      with:
        name: firmware-pico2w-rp2350-BLINK-ONLY
        path: |
          blink-test/build/blink.uf2
          blink-test/build/blink.bin
          blink-test/build/blink.elf

    - name: Upload MINIMAL test firmware
      uses: actions/upload-artifact@v4
      with:
        name: firmware-pico2w-rp2350-MINIMAL
        path: |
          build-minimal/app.uf2
          build-minimal/app.bin
          build-minimal/app.elf

    - name: Upload TEST mode firmware
      uses: actions/upload-artifact@v4
      with:
        name: firmware-pico2w-rp2350-TEST
        path: |
          build-test/app.uf2
          build-test/app.bin
          build-test/app.elf

    - name: Upload PRODUCTION mode firmware
      uses: actions/upload-artifact@v4
      with:
        name: firmware-pico2w-rp2350-PRODUCTION
        path: |
          build-production/app.uf2
          build-production/app.bin
          build-production/app.elf
