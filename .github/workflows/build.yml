name: Build Firmware

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install ARM toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake gcc-arm-none-eabi libnewlib-arm-none-eabi build-essential

    - name: Update Pico SDK to latest (for RP2350/Pico2W)
      run: |
        echo "Updating Pico SDK to latest with RP2350/Pico2W support..."
        cd library/pico-sdk
        git fetch origin
        git checkout origin/master
        git submodule update --init
        
    - name: Build for Pico 2W
      run: |
        mkdir build
        cd build
        cmake .. -DPICO_PLATFORM=rp2350 -DPICO_BOARD=pico2_w -DBUILD_OTA_BOOTLOADER=ON -DUSE_OTA_LINKER_SCRIPT=ON -DOTA_TEST_MODE=OFF
        make -j$(nproc)
        
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-pico2w
        path: |
          build/app.uf2
          build/app.bin
          build/app.elf
          
    - name: Build for Pico W (RP2040)
      run: |
        rm -rf build
        mkdir build
        cd build
        cmake .. -DPICO_BOARD=pico_w -DBUILD_OTA_BOOTLOADER=ON -DUSE_OTA_LINKER_SCRIPT=ON -DOTA_TEST_MODE=OFF
        make -j$(nproc)
        
    - name: Upload firmware artifacts (Pico W)
      uses: actions/upload-artifact@v4
      with:
        name: firmware-picow
        path: |
          build/app.uf2
          build/app.bin
          build/app.elf
